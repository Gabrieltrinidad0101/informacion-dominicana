upstream events_backend {
    server events:3001;
}

upstream grafana_backend {
    server grafana:3000;
}

upstream portainer_backend {
    server portainer:9000;
}

upstream pgadmin_ui {
    server pgadmin:80;
}

upstream mongo_ui {
    server mongo-express:8081;
}

upstream auth_backend {
    server auth:3000;
}

###############################################
# COMMON AUTH VERIFY BLOCK (for copy/paste)
###############################################
# No server block here, just for reference
#
# location = /auth_verify {
#     internal;
#     proxy_pass http://auth_backend/verify;
#     proxy_set_header Authorization $http_authorization;
#     proxy_set_header Cookie $http_cookie;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
# }

############################################################
# EVENTS SERVICE
############################################################
server { 
    listen 443 ssl;
    server_name api.informacion-dominicana.com;

    ssl_certificate /etc/letsencrypt/live/api.informacion-dominicana.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.informacion-dominicana.com/privkey.pem;

    error_page 401 = @error401;

    location @error401 {
        root /var/www/html; 
        try_files /auth.html =404;
    }
    
    auth_request /auth_verify;

    location = /auth_verify {
        internal;
        proxy_pass http://auth_backend/verify;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /events {
        proxy_pass http://events_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

############################################################
# GRAFANA
############################################################
server {
    listen 443 ssl; 
    server_name grafana.informacion-dominicana.com;

    ssl_certificate /etc/letsencrypt/live/grafana.informacion-dominicana.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/grafana.informacion-dominicana.com/privkey.pem;

    error_page 401 = @error401;

    location @error401 {
        root /var/www/html;
        try_files /auth.html =404;
    }

    location = /auth_verify {
        internal;
        proxy_pass http://auth_backend/verify;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location / {
        proxy_pass http://grafana_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

############################################################
# PORTAINER
############################################################
server {
    listen 443 ssl;
    server_name portainer.informacion-dominicana.com;

    ssl_certificate /etc/letsencrypt/live/portainer.informacion-dominicana.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/portainer.informacion-dominicana.com/privkey.pem;

    error_page 401 = @error401;

    location @error401 {
    root /var/www/html;
    try_files /auth.html =404;
}

    location = /auth_verify {
        internal;
        proxy_pass http://auth_backend/verify;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location / {
        auth_request /auth_verify;
        proxy_pass http://portainer_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

############################################################
# MONGO EXPRESS
############################################################
server {
    listen 443 ssl;
    server_name mongo.informacion-dominicana.com;

    ssl_certificate /etc/letsencrypt/live/mongo.informacion-dominicana.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mongo.informacion-dominicana.com/privkey.pem;

    error_page 401 = @error401;

    location @error401 {
    root /var/www/html;
    try_files /auth.html =404;
}

    location = /auth_verify {
        internal;
        proxy_pass http://auth_backend/verify;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location / {
        auth_request /auth_verify;
        proxy_pass http://mongo_ui;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

############################################################
# PGADMIN
############################################################
server {
    listen 443 ssl;
    server_name pgadmin.informacion-dominicana.com;

    ssl_certificate /etc/letsencrypt/live/pgadmin.informacion-dominicana.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/pgadmin.informacion-dominicana.com/privkey.pem;

    error_page 401 = @error401;

    location @error401 {
    root /var/www/html;
    try_files /auth.html =404;
}

    location = /auth_verify {
        internal;
        proxy_pass http://auth_backend/verify;
        proxy_set_header Authorization $http_authorization;
        proxy_set_header Cookie $http_cookie;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location / {
        auth_request /auth_verify;
        proxy_pass http://pgadmin_ui;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
